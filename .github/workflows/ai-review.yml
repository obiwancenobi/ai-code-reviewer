name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'node_modules/**'
      - 'build/**'
      - 'dist/**'
      - 'coverage/**'
      - '*.lock'

jobs:
  ai-review:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run AI Code Review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          AI_PROVIDER: ${{ vars.AI_PROVIDER || 'openai' }}
          AI_MODEL: ${{ vars.AI_MODEL || 'gpt-4' }}
          AI_PERSONA: ${{ vars.AI_PERSONA || 'senior-engineer' }}
          MAX_FILE_SIZE: ${{ vars.MAX_FILE_SIZE || '1048576' }}
          CHUNK_SIZE: ${{ vars.CHUNK_SIZE || '50000' }}
        run: |
          node index.js review --pr ${{ github.event.pull_request.number }} --repo ${{ github.repository }}

      - name: Comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ¤– **AI Code Review Failed**\n\nThe automated code review encountered an error. Please check the workflow logs for details.'
            })